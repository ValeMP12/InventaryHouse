var needle = require('needle');

// var opts = { agent: agent };
var opts = { timeout: 0 };
var codes = {};

var url   = process.argv[2] || (console.log('Usage: [host] [url] [concurrency]') || process.exit(1));
var count  = process.argv[3] || 1000;
require('http').globalAgent.maxSockets = process.argv[4] || 100;

var done = function() {
  var timediff = new Date() - started_at;
  console.log('Done. Seconds taken: ' + timediff/1000);
  console.log(codes);
}

var resp = function(err, resp, body) {
  var code = resp ? resp.statusCode : 'none';
  console.log('Got response: ' + (code) + ' -- ' + count + ' pending');
  if (code == 'none') console.log(err);
  if (!codes[code]) codes[code] = 0;
  codes[code]++;

  --count || done();
}

var started_at = new Date();

for(i = 0; i < count; i++){

  // var url = host + '/devices/abcd' + i;
  console.log('Making request ' + i);
  needle.get(url, opts, resp)

}
