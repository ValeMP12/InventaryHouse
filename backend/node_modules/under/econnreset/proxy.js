var util = require('util'),
    http = require('http'),
    httpProxy = require('http-proxy'),
    proxy     = require('./..').proxy;
    
var target = 'http://localhost:3000',
    port   = 8080;

// create the HTTP proxy server.
var http_proxy = httpProxy.createProxyServer({
  target: target, 
  ws: true
});

var forward = proxy.setup({
  backend: {
    host: 'localhost',
    port: 3000
  }
})
 
// listen to error
http_proxy.on('error', function (err, req, res) {
  res.writeHead(500, {
    'Content-Type': 'text/plain'
  });
 
  res.end('Something went wrong. And we are reporting a custom error message.');
});
 
// launch http server.
var http_server = http.createServer(function(req, res) {
  
  req.connection.on('error', function(e) {
    console.log('socket error')
  })
  
  forward(req, res, function(err) {
  // http_proxy.web(req, res, function (err) {
    console.log(err);
    res.writeHead(502);
    res.end("There was an error. Please try again");
  });
  
}).listen(port, function() {

  util.puts('http proxy server started on port ' + port); 
  console.log('proxying to backend at ' + target) 

});
